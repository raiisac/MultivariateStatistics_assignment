---
documentclass: article
fontsize: 10pt
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2: 
    fig_caption: yes
    toc: false
    latex_engine: xelatex
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}

update.packages("rlang")
library(xfun)
library(tidyverse)
library(rprojroot)
library(kableExtra)
library(MASS)#lda function
library(biotools)
library(ISLR2)
# this package does not work for the newest version of R --> 
# only load if the local data files are not there
if (!file.exists(find_root_file("data/rect_constr.csv", 
     criterion = has_file("MultivariateStatistics_assignment.Rproj")))) {
  library(smacof)
} 
 
knitr::opts_chunk$set(echo = TRUE)
```

# Task 1

All R scripts and the data can be found on [this GitHub repository](https://github.com/raiisac/MultivariateStatistics_assignment).
```{r load, include=FALSE, message=FALSE, warning=FALSE}
#load the data and functions
data(College)

#test the difference between centroids
Wilks_manova <- function(data, group = "Private"){
  lm.out <- lm(cbind(
    sapply(X = colnames(data)[colnames(data) != group], 
           FUN = function(x) get(x)))~ 
       get((group)), 
   data = data)
  s <- summary(manova(lm.out), test = c("Wilks"))
  return(s$stats[1, "Pr(>F)"])#return the pvalue
}
#test the differences in var-cov matrix between groups
boxM_test <- function(data, group = "Private"){
  out <- boxM(data[,colnames(data) != group], data[,group])
  return(out$p.value)#return the pvalue
}

#execute lda with LOOCV and save the hit rate, sensitivity, and specificity
lda_analysis <- function(data, group = "Private", datatype){
  K <- length(unique(levels(data[,group])))
  positivelevel <- levels(data[,group])[K]# by default, it is assumed the last level is the positive level
  negativelevel <-  levels(data[,group])[-K]
  lda.out <- lda(
    formula(paste0(group, "~", paste(colnames(data)[colnames(data) != group], 
                                     collapse = "+"))),
    data = data,
    prior = rep(1/K, K),
    CV = TRUE)
  tab <- table(data[,group], lda.out$class)
  out <- data.frame(hitrate = sum(diag(tab))/sum(tab),
                    sensitivity = tab[positivelevel, positivelevel] /
                      sum(tab[positivelevel,]),
                    specificity = tab[negativelevel, negativelevel] /
                      sum(tab[negativelevel,]),
                    data = datatype,
                    method = "LDA"
  )
  return(out)
}
#execute qda with LOOCV and save the hit rate, sensitivity, and specificity
qda_analysis <- function(data, group = "Private", datatype){
  K <- length(unique(levels(data[,group])))
  positivelevel <- levels(data[,group])[K]# by default, it is assumed the last level is the positive level
  negativelevel <-  levels(data[,group])[-K]
  qda.out <- qda(
    formula(paste0(group, "~", paste(colnames(data)[colnames(data) != group], 
                                     collapse = "+"))),
    data = data,
    prior = rep(1/K, K),
    CV = TRUE)
  tab <- table(data[,group], qda.out$class)
  out <- data.frame(hitrate = sum(diag(tab))/sum(tab),
                    sensitivity = tab[positivelevel, positivelevel] /
                      sum(tab[positivelevel,]),
                    specificity = tab[negativelevel, negativelevel] /
                      sum(tab[negativelevel,]),
                    data = datatype,
                    method = "QDA"
  )
  return(out)
}

knn <-  function(data, group = "Private"){
  lda.out <- lda(
    formula(paste0(group, "~", paste(colnames(data)[colnames(data) != group], 
                                     collapse = "+"))),
    data = data)
}


confusion <-  function(true, predicted){#two vectors of the same length for the true group classification and the predicted group classification
 #put code here to calculate hit rate, sensitivity, specificity
}

```

The data consists of `r ncol(College)` variables of which the categorical variable *Private* denotes whether the school is private (*Private == Yes*) or not (*Private == No*). There are `r nrow(College)` schools in the data; `r sum(College$Private == "Yes")` (`r round(sum(College$Private == "Yes")/nrow(College)*100,2)`%) private schools and `r sum(College$Private == "No")` (`r round(sum(College$Private == "No")/nrow(College)*100,2)`%) non-private schools.

Before we start to build models to distinguish private and non-private schools, Wilk's lambda test is performed where the null hypothesis states that the centroid (mean) in both groups is the same. Both in the log-transformed and the original (centered or standardized) data, this null hypothesis is rejected. This means that the centroids of private and non-private schools differ significantly. 

The test of Box to test for equality of within-group covariance matrices shows that $H_0$ of equal covariance matrices across groups is not supported by the data. However, we still report on the results from LDA (which assumes equal covariances) since the alternative, QDA, does not always perform better because lower bias of the QDA classifier mat not outweigh its higher model complexity.

```{r classification, include=FALSE, message=FALSE, warning=FALSE}
College_logtranfskewed <- College %>%
  mutate(Apps = log(Apps),
         Accept = log(Accept),
         Enroll = log(Enroll),
         Top10perc = log(Top10perc),
         F.Undergrad = log(F.Undergrad),
         P.Undergrad = log(P.Undergrad),
         Books = log(Books),
         Personal = log(Personal),
         Expend = log(Expend))
College_centered <- College %>% 
  dplyr::select(-Private) %>% 
  scale(center = TRUE, scale = FALSE) %>%
  as.data.frame() %>%
  mutate(Private = College$Private)
College_logtranfskewed_centered <- College_logtranfskewed %>% 
  dplyr::select(-Private) %>%  
  scale(center = TRUE, scale = FALSE) %>%
  as.data.frame() %>%
  mutate(Private = College$Private)
College_std <- College %>% 
  dplyr::select(-Private) %>%  
  scale(center = TRUE, scale = TRUE) %>%
  as.data.frame() %>%
  mutate(Private = College$Private)
College_logtranfskewed_std <- College_logtranfskewed %>% 
  dplyr::select(-Private) %>%  
  scale(center = TRUE, scale = TRUE) %>%
  as.data.frame() %>%
  mutate(Private = College$Private)

testlist <- list(center = College_centered,
                 center_logtransfskewed = College_logtranfskewed_centered,
                 std = College_std,
                 std_logtransfskewed = College_logtranfskewed_std
                 )

#test the difference between centroids
testlist %>% map(function(x) Wilks_manova(x, "Private"))
#In each dataset, H0:mu_{yes} = mu_{no} is rejected --> centroids of Private and non-private schools differ significantly
#test the difference between centroids
testlist %>% map(function(x) boxM_test(x, "Private"))

#LDA
lda_results <- map2(testlist, names(testlist), 
                    function(x,y){lda_analysis(x,"Private", y)})
  
#QDA
qda_results <- map2(testlist, names(testlist), 
                    function(x,y){qda_analysis(x,"Private", y)})
  
#bagging

#random forsts

#KNN

```


# Task 2

```{r load2, include=FALSE, message=FALSE, warning=FALSE}
load(find_root_file("data/fashion.Rdata", 
     criterion = has_file("MultivariateStatistics_assignment.Rproj")))
train.data <- train.data %>% scale(center = TRUE, scale = FALSE)
```

# Task 3
```{r load3, include=FALSE, message=FALSE, warning=FALSE}
if (file.exists(find_root_file("data/rect_constr.csv", 
     criterion = has_file("MultivariateStatistics_assignment.Rproj")))) {
  rect_constr <- read.csv(
    find_root_file("data/rect_constr.csv", 
                   criterion = 
                     has_file("MultivariateStatistics_assignment.Rproj")))
} else {
  data(rect_constr) 
}
if (file.exists(find_root_file("data/rectangles.csv", 
     criterion = has_file("MultivariateStatistics_assignment.Rproj")))) {
  rectangles <- read.csv(
    find_root_file("data/rectangles.csv", 
                   criterion = 
                     has_file("MultivariateStatistics_assignment.Rproj")))
} else {
  data(rectangles) 
}
```

# Appendix

