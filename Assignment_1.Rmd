---
documentclass: article
fontsize: 12pt
date: "`r Sys.Date()`"
output: 
  bookdown::pdf_document2: 
    fig_caption: yes
    toc: false
    latex_engine: xelatex
    includes:
      in_header: preamble.sty
      before_body: titlepage.sty
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(rprojroot)
library(lavaan)
library(tidySEM)#to graphically represent SEM
library(kableExtra)
knitr::opts_chunk$set(echo = TRUE)
```

# Task 1

```{r load, include=FALSE, message=FALSE, warning=FALSE}
load(find_root_file("data/cosmetics.Rdata", 
     criterion = has_file("MultivariateStatistics_assignment.Rproj")))
colnames(cosmetics) <- str_replace(colnames(cosmetics), 
                                   pattern = "Attitude_", 
                                   "A_") #shorten the names of the variables
```

## CFA to construct a measurement model for the Attitude items
There are `r sum(str_detect(colnames(cosmetics),"Attitude"))` attitude items that are scored on a five-point Likert scale.

We first conduct a simple confirmatory factor analysis, assuming each item only has a loading on the concept it aims to measure (organic, packaging, and cruelty free). We will assume the the three latent variables are correlated. Table \@ref(tab:CFA1performance) shows several performance measures for the model. Figure \@ref(fig:CFA1graphical) shows a graphical representation of the model, including all correlations and variances.

```{r CFA1, include=FALSE, message=FALSE, warning=FALSE}
#We first center the variables
cosmetics_center <- scale(cosmetics, center = TRUE)
covmat1 <- cov(cosmetics_center[,1:9])
simplemodel1 <- 
'organic = ~NA*A_organic1 + A_organic2 + A_organic3
  packaging = ~NA*A_packaging1 + A_packaging2 + A_packaging3
  crueltyfree = ~A_crueltyfree1 + A_crueltyfree2 + A_crueltyfree3
  organic ~~ 1*organic
  packaging ~~ 1*packaging
  crueltyfree ~~ 1*crueltyfree
  organic ~~ packaging
  organic ~~ crueltyfree
  packaging ~~ crueltyfree'
fit1 <- cfa(simplemodel1, sample.cov = covmat1, sample.nobs = nrow(cosmetics))
sum_fit1 <- summary(fit1, fit.measure = T)
```

```{r CFA1performance, echo=FALSE, message=FALSE, warning=FALSE}
data.frame(
  parameter = c('user model Chisq. (df, p-value)',
                "baseline model Chisq. (df, p-value)",
                "comparative fit index (CFI)",
                "Tucker-Lewis index (TLI)",
                "Loglik user model (H0)",
                "Loglik unrestricted model(H1)",
                "Akaike (AIC)",
                "Bayesian (BIC)",
                "RMSEA (ll,ul) (pvalue)",
                "Standardized root mean square residual"),
  value = c(sprintf("%.2f (%.0f, %.2f)", sum_fit1$fit["chisq"],
                    sum_fit1$fit["df"], sum_fit1$fit["pvalue"]),
            sprintf("%.2f (%.0f, %.2f)", sum_fit1$fit["baseline.chisq"],
                    sum_fit1$fit["baseline.df"], 
                    sum_fit1$fit["baseline.pvalue"]),
            round(sum_fit1$fit["cfi"], digits = 3),
            round(sum_fit1$fit["tli"], digits = 3),
            round(sum_fit1$fit["logl"], digits = 3),
            round(sum_fit1$fit["unrestricted.logl"], digits = 3),
            round(sum_fit1$fit["aic"], digits = 3),
            round(sum_fit1$fit["bic"], digits = 3),
            sprintf("%.2f (%.2f, %.2f) (%.2f)", sum_fit1$fit["rmsea"],
                    sum_fit1$fit["rmsea.ci.lower"], 
                    sum_fit1$fit["rmsea.ci.upper"], 
                    sum_fit1$fit["rmsea.pvalue"]),
            round(sum_fit1$fit["srmr"], digits = 3))
) %>%
  kable(col.names = c("Performance measure","Value"),
        align = "lc",
        caption = "Performance of the simple model for the attitudes",
        booktabs = TRUE) %>%
  kableExtra::kable_styling(latex_options = "HOLD_position")

```


```{r CFA1graphical, echo=FALSE, message=FALSE, warning=FALSE, fig.cap = "A graphical representation of the simple model for the attitudes.", out.width = "15cm", fig.align='center'}
lay <- get_layout("", "", "organic","","packaging","","crueltyfree","", "",
                  "A_organic1", "A_organic2", "A_organic3", 
                  "A_packaging1", "A_packaging2", "A_packaging3", 
                  "A_crueltyfree1", "A_crueltyfree2", "A_crueltyfree3", 
                  rows = 2)
p <- graph_sem(model = fit1, layout = lay)
if (!file.exists("figures/CFA1graphical.png")) {
  ggsave("figures/CFA1graphical.png", p, 
         device = "png", width = 11, height = 4)}
knitr::include_graphics(find_root_file("figures/CFA1graphical.png", 
    criterion = has_file("MultivariateStatistics_assignment.Rproj")))
```

## CFA to construct a measurement model for the Behavior-Intention items
There are `r sum(str_detect(colnames(cosmetics),"BI"))` behavior-intention items that are scored on a five-point Likert scale. 

## Structural equation model to evaluate the impact of attitude on behavior intention

# Task 2

```{r load2, include=FALSE, message=FALSE, warning=FALSE}
load(find_root_file("data/benefits.Rdata", 
     criterion = has_file("MultivariateStatistics_assignment.Rproj")))
```

## Canonical correlation analysis


## Split-half approach
